repeat task.wait() until game:IsLoaded()
task.wait(2) -- Shorter initial wait

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local player = Players.LocalPlayer
local username = player.Name
local playerGui = player:WaitForChild("PlayerGui")

-- CONFIGURATION
local SEARCH_NAME = "Mythical Fruit Chest"
local DISPLAY_NAME = "Mythic Chests"
local saveFile = "mythic_chest_count_" .. username .. ".txt"

-- Function to create UI in CoreGui (above everything)
local function createOverlay()
    -- Cleanup old
    pcall(function()
        local old = CoreGui:WaitForChild("MenuFrameCore", 1)
        if old then old:Destroy() end
    end)
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MenuFrameCore"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    screenGui.DisplayOrder = 2147483647
    screenGui.Parent = CoreGui -- PARENT TO COREGUI (above PlayerGui)
    
    -- Black background
    local blackFrame = Instance.new("Frame")
    blackFrame.Name = "Background"
    blackFrame.Size = UDim2.new(1, 0, 1, 100)
    blackFrame.Position = UDim2.new(0, 0, 0, -50)
    blackFrame.BackgroundColor3 = Color3.new(0.02, 0.02, 0.02)
    blackFrame.BackgroundTransparency = 0
    blackFrame.BorderSizePixel = 0
    blackFrame.ZIndex = 2147483647
    blackFrame.Parent = screenGui
    
    -- MYTHIC CHEST COUNTER
    local chestFrame = Instance.new("Frame")
    chestFrame.Name = "ChestFrame"
    chestFrame.Size = UDim2.new(0, 140, 0, 28)
    chestFrame.Position = UDim2.new(1, -150, 1, -75)
    chestFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    chestFrame.BackgroundTransparency = 0.3
    chestFrame.BorderSizePixel = 0
    chestFrame.ZIndex = 2147483647
    chestFrame.Parent = screenGui
    
    local chestCorner = Instance.new("UICorner")
    chestCorner.CornerRadius = UDim.new(0, 6)
    chestCorner.Parent = chestFrame
    
    local chestLabel = Instance.new("TextLabel")
    chestLabel.Name = "ChestCounter"
    chestLabel.Size = UDim2.new(1, 0, 1, 0)
    chestLabel.BackgroundTransparency = 1
    chestLabel.Text = DISPLAY_NAME .. ": ..."
    chestLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
    chestLabel.Font = Enum.Font.GothamSemibold
    chestLabel.TextSize = 14
    chestLabel.TextXAlignment = Enum.TextXAlignment.Center
    chestLabel.ZIndex = 2147483647
    chestLabel.Parent = chestFrame
    
    -- FPS/Ping
    local infoFrame = Instance.new("Frame")
    infoFrame.Name = "InfoFrame"
    infoFrame.Size = UDim2.new(0, 110, 0, 24)
    infoFrame.Position = UDim2.new(1, -120, 1, -40)
    infoFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    infoFrame.BackgroundTransparency = 0.3
    infoFrame.BorderSizePixel = 0
    infoFrame.ZIndex = 2147483647
    infoFrame.Parent = screenGui
    
    local infoCorner = Instance.new("UICorner")
    infoCorner.CornerRadius = UDim.new(0, 6)
    infoCorner.Parent = infoFrame
    
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Name = "StatusText"
    infoLabel.Size = UDim2.new(1, 0, 1, 0)
    infoLabel.BackgroundTransparency = 1
    infoLabel.Text = "..."
    infoLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    infoLabel.Font = Enum.Font.Gotham
    infoLabel.TextSize = 12
    infoLabel.TextXAlignment = Enum.TextXAlignment.Center
    infoLabel.ZIndex = 2147483647
    infoLabel.Parent = infoFrame
    
    return screenGui, chestLabel, infoLabel
end

-- Create immediately
local screenGui, chestLabel, infoLabel = createOverlay()

-- AGGRESSIVE RECREATE LOOP - If destroyed or hidden, recreate instantly
task.spawn(function()
    while true do
        task.wait(0.1)
        pcall(function()
            -- Check if still exists and visible
            if not screenGui or not screenGui.Parent then
                screenGui, chestLabel, infoLabel = createOverlay()
                print("[" .. username .. "] Overlay recreated")
            end
            
            -- Force visible
            if screenGui then
                screenGui.Enabled = true
                screenGui.DisplayOrder = 2147483647
            end
        end)
    end
end)

-- Also recreate if CoreGui gets cleared
CoreGui.ChildRemoved:Connect(function(child)
    if child.Name == "MenuFrameCore" then
        task.wait(0.1)
        pcall(function()
            screenGui, chestLabel, infoLabel = createOverlay()
        end)
    end
end)

-- FPS calc
local fps = 0
local frameCount = 0
local lastTime = tick()

RunService.Heartbeat:Connect(function()
    frameCount += 1
    local now = tick()
    if now - lastTime >= 0.5 then
        fps = math.floor(frameCount / (now - lastTime))
        frameCount = 0
        lastTime = now
    end
end)

-- Mythic Chest Functions
local function checkMainMenu()
    local success, result = pcall(function()
        local startGui = playerGui:FindFirstChild("Start")
        if startGui then
            return startGui:FindFirstChild("Menu") ~= nil
        end
        return false
    end)
    return success and result
end

local function saveCount(count)
    pcall(function()
        writefile(saveFile, tostring(count))
    end)
end

local function loadCount()
    local success, result = pcall(function()
        if isfile(saveFile) then
            return tonumber(readfile(saveFile))
        end
        return nil
    end)
    return success and result
end

local function getItemCount()
    local success, result = pcall(function()
        local statsPath = game:GetService("ReplicatedStorage")
            :WaitForChild("Stats" .. username)
            :WaitForChild("Inventory")
            :WaitForChild("Inventory")
        
        local data = statsPath.Value
        local inventory = HttpService:JSONDecode(data)
        return inventory[SEARCH_NAME] or 0
    end)
    
    if success then
        return result
    else
        return nil
    end
end

-- Update chest display
local function updateChestDisplay()
    local isInMainMenu = checkMainMenu()
    local currentCount = nil
    
    if isInMainMenu then
        currentCount = getItemCount()
        if currentCount ~= nil then
            saveCount(currentCount)
            chestLabel.Text = DISPLAY_NAME .. ": x" .. currentCount
            chestLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            currentCount = loadCount()
            if currentCount then
                chestLabel.Text = DISPLAY_NAME .. ": x" .. currentCount
                chestLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            else
                chestLabel.Text = DISPLAY_NAME .. ": x0"
                chestLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            end
        end
    else
        currentCount = loadCount()
        if currentCount ~= nil then
            chestLabel.Text = DISPLAY_NAME .. ": x" .. currentCount
            chestLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
        else
            chestLabel.Text = DISPLAY_NAME .. ": x0"
            chestLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
    end
end

-- Update FPS/Ping
local function updateInfo()
    while true do
        pcall(function()
            local ping = 0
            pcall(function()
                ping = math.floor(Stats.PerformanceStats.Ping:GetValue())
            end)
            if infoLabel then
                infoLabel.Text = fps .. " FPS  " .. ping .. "ms"
            end
        end)
        task.wait(0.1)
    end
end

-- Update chest count
local function updateChestLoop()
    while true do
        pcall(updateChestDisplay)
        task.wait(3)
    end
end

-- Start loops
task.spawn(updateInfo)
task.spawn(updateChestLoop)

print("=== GPO CoreGui Overlay + Mythic Chest Counter Loaded ===")
print("Account: " .. username)
print("Mode: CoreGui (UNSTOPPABLE)")
