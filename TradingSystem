repeat task.wait(1) until game:IsLoaded()  -- Slower initial wait
task.wait(math.random(5, 8))               -- Random delay, less bot-like

if not getgenv().MC_Trading_Config then
    warn("Config not found")
    return
end

local CONFIG = getgenv().MC_Trading_Config
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local username = player.Name

local DATA_FOLDER = "MC_Trading_System/"

-- Safety limits
local actionCount = 0
local MAX_ACTIONS_PER_MIN = 10  -- Rate limiting

local function safeWait(min, max)
    task.wait(math.random(min or 2, max or 4))
end

local function canPerformAction()
    actionCount = actionCount + 1
    if actionCount > MAX_ACTIONS_PER_MIN then
        task.wait(60)  -- Cooldown
        actionCount = 0
    end
    return true
end

local function log(msg)
    if CONFIG.Debug then print(string.format("[%.1f] %s", tick() % 1000, msg)) end
end

-- Safer file operations (less frequent)
local lastSave = 0
local function saveData(filename, data)
    if tick() - lastSave < 10 then return end  -- Don't save too often
    lastSave = tick()
    
    pcall(function()
        if not isfolder(DATA_FOLDER) then makefolder(DATA_FOLDER) end
        writefile(DATA_FOLDER .. filename .. ".json", HttpService:JSONEncode(data))
    end)
end

-- Safer location check (less intensive)
local lastLocationCheck = 0
local cachedLocation = "unknown"

local function updateLocation()
    if tick() - lastLocationCheck < 3 then return cachedLocation end
    lastLocationCheck = tick()
    
    local success, result = pcall(function()
        local pg = player:FindFirstChild("PlayerGui")
        if not pg then return "loading" end
        
        -- Check Trade Hub first (more specific)
        if pg:FindFirstChild("TradeMenu") or pg:FindFirstChild("chooseType") then
            return "tradehub"
        end
        
        -- Check Main Menu
        local start = pg:FindFirstChild("Start")
        if start and start:FindFirstChild("Menu") then
            return "mainmenu"
        end
        
        return "ingame"
    end)
    
    cachedLocation = success and result or "unknown"
    return cachedLocation
end

-- Safer MC count (with cooldown)
local lastMCCheck = 0
local cachedMC = 0

local function getMCCount()
    if tick() - lastMCCheck < 10 then return cachedMC end
    lastMCCheck = tick()
    
    local success, result = pcall(function()
        -- Only check if we're in main menu (safer)
        if updateLocation() ~= "mainmenu" then return cachedMC end
        
        local statsPath = ReplicatedStorage:WaitForChild("Stats" .. username)
            :WaitForChild("Inventory")
            :WaitForChild("Inventory")
        local data = statsPath.Value
        local inventory = HttpService:JSONDecode(data)
        return inventory["Mythical Fruit Chest"] or 0
    end)
    
    if success then cachedMC = result end
    return cachedMC
end

-- Safer teleport (with cooldown)
local lastTeleport = 0
local function safeTeleport(method, ...)
    if tick() - lastTeleport < 15 then  -- Max 1 teleport per 15s
        log("Teleport cooldown active")
        return false
    end
    lastTeleport = tick()
    
    if not canPerformAction() then return false end
    
    local success = pcall(method, ...)
    if success then task.wait(8) end  -- Long wait after teleport
    return success
end

-- Join Trade Hub (single attempt, no spam)
local function joinTradeHubLobby()
    if not canPerformAction() then return false end
    
    log("Joining lobby...")
    safeWait(3, 5)  -- Wait for GUI to settle
    
    local success = pcall(function()
        local chooseType = player:WaitForChild("PlayerGui"):WaitForChild("chooseType", 10)
        if not chooseType then return false end
        
        safeWait(2, 3)
        
        local frame = chooseType:WaitForChild("Frame", 5)
        if not frame then return false end
        
        local remoteEvent = frame:WaitForChild("RemoteEvent", 5)
        if not remoteEvent then return false end
        
        -- Single fire, no spam
        remoteEvent:FireServer("tradeHub")
        return true
    end)
    
    if success then safeWait(5, 7) end
    return success
end

-- Execute Impel (safer loading)
local function executeImpelScript()
    log("Loading Impel script...")
    
    -- Set key
    getgenv().script_key = CONFIG.ImpelScriptKey
    
    -- Load in separate thread with error handling
    task.spawn(function()
        local success, err = pcall(function()
            loadstring(game:HttpGet(CONFIG.ImpelScriptURL))()
        end)
        if not success then
            log("Impel load failed: " .. tostring(err))
        end
    end)
end

-- Safer trade (minimal remote firing)
local function performTrade(targetName, amount)
    if not canPerformAction() then return false end
    
    log("Trading with " .. targetName)
    
    -- Phase 1: Request (single attempt)
    safeWait(2, 3)
    pcall(function()
        ReplicatedStorage.trade:FireServer({requestTrade = targetName})
    end)
    
    safeWait(4, 6)  -- Wait for acceptance
    
    -- Phase 2: Add items (single fire)
    if not canPerformAction() then return false end
    pcall(function()
        ReplicatedStorage.trade:FireServer({
            addItem = "Mythical Fruit Chest",
            customCount = amount
        })
    end)
    
    safeWait(3, 4)
    
    -- Phase 3: Confirm (single fire)
    if not canPerformAction() then return false end
    pcall(function()
        ReplicatedStorage.trade:FireServer({accept = true})
    end)
    
    -- Wait for completion (passive listening)
    local completed = false
    local connection
    connection = ReplicatedStorage.Events.note.OnClientEvent:Connect(function(msg)
        if msg and msg:find("Trade completed") then
            completed = true
            if connection then connection:Disconnect() end
        end
    end)
    
    for i = 1, CONFIG.Timings.TradeTimeout do
        if completed then break end
        task.wait(1)
    end
    
    if connection then connection:Disconnect() end
    return completed
end

-- Main logic (slower loops)
local function farmingAltLogic()
    log("Farming mode")
    local retries = 0
    
    while retries < CONFIG.MaxRetries do
        local location = updateLocation()
        
        if location == "mainmenu" then
            local mcCount = getMCCount()
            log("MCs: " .. mcCount)
            
            if mcCount > 0 then
                -- Go to trade
                saveData("alt_" .. username, {MCs = mcCount, Status = "trading"})
                
                if safeTeleport(function()
                    ReplicatedStorage.Events.reserved:InvokeServer(CONFIG.PSCode)
                end) then
                    -- Successfully teleported, loop will continue in tradehub
                else
                    retries = retries + 1
                end
            else
                -- Farm
                saveData("alt_" .. username, {MCs = 0, Status = "farming"})
                safeWait(5, 8)  -- Wait before loading script
                executeImpelScript()
                return  -- Script handles farming, we exit
            end
            
        elseif location == "tradehub" then
            local data = loadData("alt_" .. username) or {MCs = 0}
            
            if data.MCs > 0 then
                if joinTradeHubLobby() then
                    safeWait(10, 15)  -- Wait for server population
                    
                    -- Find main
                    local main = CONFIG.ReceivingMains[1]
                    local found = false
                    
                    for i = 1, 30 do  -- 30s max wait
                        if Players:FindFirstChild(main.Name) then
                            found = true
                            break
                        end
                        task.wait(1)
                    end
                    
                    if found then
                        if performTrade(main.Name, data.MCs) then
                            log("Trade done")
                            saveData("alt_" .. username, {MCs = 0})
                            safeWait(10, 15)
                            safeTeleport(TeleportService.Teleport, CONFIG.MainGamePlaceId, player)
                            return
                        else
                            retries = retries + 1
                        end
                    else
                        log("Main not found")
                        retries = retries + 1
                    end
                end
            else
                -- Shouldn't be here
                safeTeleport(TeleportService.Teleport, CONFIG.MainGamePlaceId, player)
                return
            end
            
        else
            -- In game or loading
            log("Location: " .. location)
            safeWait(10, 15)
        end
        
        safeWait(CONFIG.Timings.CheckInterval, CONFIG.Timings.CheckInterval + 5)
    end
    
    log("Max retries reached")
end

-- Receiving main (passive, minimal actions)
local function receivingMainLogic()
    log("Receiving mode")
    
    -- Just ensure we're in trade hub
    if updateLocation() ~= "tradehub" then
        safeTeleport(function()
            ReplicatedStorage.Events.reserved:InvokeServer(CONFIG.PSCode)
        end)
        task.wait(10)
    end
    
    if updateLocation() == "tradehub" then
        joinTradeHubLobby()
    end
    
    -- Passive loop - just wait for trades
    while true do
        if canPerformAction() then
            -- Check if we're in a trade
            local inTrade = pcall(function()
                return player:WaitForChild("PlayerGui"):FindFirstChild("TradeGUI") ~= nil
            end)
            
            if inTrade then
                log("Accepting trade")
                safeWait(2, 4)
                
                -- Single accept
                pcall(function()
                    ReplicatedStorage.trade:FireServer({accept = true})
                end)
                
                safeWait(5, 8)
                
                -- Single confirm
                pcall(function()
                    ReplicatedStorage.trade:FireServer({accept = true})
                end)
                
                task.wait(20)  -- Long cooldown after trade
            end
        end
        
        task.wait(5)  -- Slow check loop
    end
end

-- Initialize
local function init()
    log("Safe Trading System v3.0")
    
    local isAlt = false
    for _, name in pairs(CONFIG.FarmingAlts) do
        if name == username then isAlt = true break end
    end
    
    local isMain = false
    for _, main in pairs(CONFIG.ReceivingMains) do
        if main.Name == username then isMain = true break end
    end
    
    safeWait(3, 5)  -- Initial safety wait
    
    if isAlt then
        farmingAltLogic()
    elseif isMain then
        receivingMainLogic()
    else
        warn("Account not configured")
    end
end

init()
