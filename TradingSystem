-- ============================================
-- GPO TRADE SCRIPT – FINAL WITH ITEM CONFIRMATION
-- Accounts: Sunsetblue5006 (farmer), Mynameisallah123456 (receiver)
-- ============================================

-- Prevent multiple runs
if _G.GPO_FinalTrade_Running then return end
_G.GPO_FinalTrade_Running = true

repeat task.wait(1) until game:IsLoaded()
task.wait(10)

-- ===== CONFIG =====
local PRIVATE_SERVER_CODE = "8Zqh4oOLVN"
local ITEM_NAME = "Common Fish Bait"
local RECEIVER_NAME = "Mynameisallah123456"
local SENDER_NAME = "Sunsetblue5006"
-- ==================

-- Place IDs
local MAIN_MENU_ID = 1730877806
local TRADE_HUB_ID = 6811831486

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Track trade notes
local tradeCompleted = false
local tradeCanceled = false
local lastNote = ""

local noteRemote = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("note")
if noteRemote then
    noteRemote.OnClientEvent:Connect(function(msg)
        print("NOTE: " .. msg)
        lastNote = msg
        if msg:find("Trade completed!") then
            tradeCompleted = true
        elseif msg:find("Trade has been canceled!") then
            tradeCanceled = true
        end
    end)
end

local function randomDelay(min, max)
    task.wait(min + math.random() * (max - min))
end

-- ============================================
-- INVENTORY CHECK FROM STATS (MAIN MENU)
-- ============================================
local function getItemCount(itemName)
    local statsFolder = ReplicatedStorage:FindFirstChild("Stats" .. player.Name)
    if not statsFolder then
        statsFolder = ReplicatedStorage:WaitForChild("Stats" .. player.Name, 10)
        if not statsFolder then return 0 end
    end
    local invFolder = statsFolder:FindFirstChild("Inventory")
    if not invFolder then return 0 end
    local invData = invFolder:FindFirstChild("Inventory")
    if not invData then return 0 end
    local json = invData.Value
    if type(json) ~= "string" then return 0 end
    local success, data = pcall(function() return HttpService:JSONDecode(json) end)
    if not success then return 0 end
    return data[itemName] or 0
end

-- ============================================
-- TELEPORT TO MAIN MENU (for sender only)
-- ============================================
local function leaveTradeHub()
    if game.PlaceId == TRADE_HUB_ID then
        print("Leaving trade hub to main menu...")
        task.wait(2)
        TeleportService:Teleport(MAIN_MENU_ID)
    end
end

-- ============================================
-- JOIN PRIVATE SERVER (FROM MAIN MENU)
-- ============================================
local function joinPrivateServer()
    if game.PlaceId ~= MAIN_MENU_ID then
        warn("Not in main menu, cannot join private server.")
        return false
    end

    print("In main menu. Joining private server...")
    local reserved = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("reserved")
    if not reserved then
        warn("reserved remote not found")
        return false
    end

    coroutine.wrap(function()
        pcall(function() reserved:InvokeServer(PRIVATE_SERVER_CODE) end)
    end)()

    local chooseType = nil
    local start = tick()
    while tick() - start < 30 do
        chooseType = playerGui:FindFirstChild("chooseType")
        if chooseType then break end
        task.wait(1)
    end
    if not chooseType then
        warn("chooseType GUI not found")
        return false
    end

    local frame = chooseType:FindFirstChild("Frame")
    if not frame then
        warn("Frame not found")
        return false
    end

    local remoteEvent = frame:FindFirstChild("RemoteEvent")
    if not remoteEvent then
        warn("RemoteEvent not found")
        return false
    end

    print("Selecting Trade Hub...")
    remoteEvent:FireServer("tradeHub")
    randomDelay(10, 12)
    return true
end

-- ============================================
-- HANDLE "I UNDERSTAND" PROMPT
-- ============================================
local function handleConfirmation()
    print("Waiting for ConfirmationPrompt (up to 15s)...")
    local prompt = nil
    local start = tick()
    while tick() - start < 15 do
        prompt = playerGui:FindFirstChild("ConfirmationPrompt")
        if prompt then
            print("ConfirmationPrompt found.")
            break
        end
        task.wait(0.5)
    end

    if prompt then
        local remote = prompt:FindFirstChild("RemoteEvent")
        if remote then
            remote:FireServer("I understand")
            print("Fired 'I understand'")
            task.wait(1)
        else
            warn("RemoteEvent not found in prompt")
        end
    else
        print("No ConfirmationPrompt appeared within 15s – assuming already accepted or trade opened directly.")
    end
end

-- ============================================
-- CHECK IF ITEM ALREADY ADDED IN TRADE (PLAYER'S SIDE)
-- ============================================
local function hasAddedItem(itemName)
    local tradeGUI = playerGui:FindFirstChild("TradeGUI")
    if not tradeGUI then return false end
    local main = tradeGUI:FindFirstChild("Main")
    if not main then return false end
    local playerItems = main:FindFirstChild("Player") and main.Player:FindFirstChild("Items")
    if not playerItems then return false end
    local item = playerItems:FindFirstChild(itemName)
    if item then
        local amountLabel = item:FindFirstChild("Amount")
        if amountLabel and amountLabel:IsA("TextLabel") then
            local text = amountLabel.Text
            if text:match("x(%d+)") then
                return true
            end
        end
    end
    return false
end

-- ============================================
-- CHECK IF TRADER HAS ADDED ANY ITEM (RECEIVER'S JUNK)
-- ============================================
local function traderHasAnyItem()
    local tradeGUI = playerGui:FindFirstChild("TradeGUI")
    if not tradeGUI then return false end
    local main = tradeGUI:FindFirstChild("Main")
    if not main then return false end
    local traderItems = main:FindFirstChild("Trader") and main.Trader:FindFirstChild("Items")
    if not traderItems then return false end
    -- If there's any child in Items folder, trader has added something
    return #traderItems:GetChildren() > 0
end

-- ============================================
-- WAIT FOR BOTH SIDES TO HAVE ITEMS
-- ============================================
local function waitForBothItemsAdded(timeout)
    local start = tick()
    while tick() - start < timeout do
        if hasAddedItem(ITEM_NAME) and traderHasAnyItem() then
            print("Both sides have items.")
            return true
        end
        task.wait(1)
    end
    print("Timeout waiting for both sides to have items.")
    return false
end

-- ============================================
-- MONITOR STATUS AND RE‑ACCEPT IF NEEDED
-- ============================================
local function monitorAndReAccept(tradeMain, tradeRemote, maxAttempts)
    local playerStatus = tradeMain:FindFirstChild("Player") and tradeMain.Player:FindFirstChild("Status")
    local traderStatus = tradeMain:FindFirstChild("Trader") and tradeMain.Trader:FindFirstChild("Status")
    if not playerStatus or not traderStatus then return false end

    local attempts = 0
    while attempts < maxAttempts do
        if tradeCompleted then
            print("Trade completed detected via note")
            return true
        end
        if tradeCanceled then
            print("Trade canceled detected")
            return false
        end
        if playerStatus.Text == "ACCEPTED" and traderStatus.Text == "ACCEPTED" then
            print("Both accepted.")
            return true
        elseif playerStatus.Text == "DECIDING" then
            print("Status went back to DECIDING, re‑accepting...")
            tradeRemote:FireServer({ accept = true })
            attempts = attempts + 1
        end
        task.wait(1)
    end
    return false
end

-- ============================================
-- SENDER (FARMER) FUNCTIONS
-- ============================================
local function sendTrade()
    print("Sending trade invite...")
    coroutine.wrap(function()
        pcall(function()
            ReplicatedStorage.Events.trade:InvokeServer({ invitedPlayer = RECEIVER_NAME, invite = true })
        end)
    end)()
    randomDelay(2, 3)
    handleConfirmation()
    randomDelay(2, 3)
end

local function executeTrade()
    print("Waiting for TradeGUI (up to 20s)...")
    local tradeGUI = nil
    local start = tick()
    while tick() - start < 20 do
        tradeGUI = playerGui:FindFirstChild("TradeGUI")
        if tradeGUI then
            print("TradeGUI found.")
            break
        end
        task.wait(1)
    end
    if not tradeGUI then
        print("TradeGUI not found – trade may have failed.")
        return false
    end
    local main = tradeGUI:FindFirstChild("Main")
    if not main then return false end

    local tradeRemote = ReplicatedStorage:FindFirstChild("trade")
    if not tradeRemote or not tradeRemote:IsA("RemoteEvent") then
        tradeRemote = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("trade")
    end
    if not tradeRemote then
        warn("Trade remote not found")
        return false
    end

    -- Add item if not already present
    if not hasAddedItem(ITEM_NAME) then
        tradeRemote:FireServer({ addItem = ITEM_NAME, customCount = 1 })
        print("Added item, waiting for confirmation...")
        local waitStart = tick()
        while tick() - waitStart < 5 do
            if hasAddedItem(ITEM_NAME) then
                print("Item confirmed in trade window.")
                break
            end
            task.wait(0.5)
        end
        if not hasAddedItem(ITEM_NAME) then
            print("Item did not appear, retrying...")
            tradeRemote:FireServer({ addItem = ITEM_NAME, customCount = 1 })
            task.wait(2)
            if not hasAddedItem(ITEM_NAME) then
                print("Failed to add item, aborting trade.")
                return false
            end
        end
    else
        print("Item already added")
    end

    -- Wait for receiver to add their junk item
    if not waitForBothItemsAdded(20) then
        print("Receiver did not add item in time, aborting.")
        return false
    end

    randomDelay(2, 3)
    tradeRemote:FireServer({ accept = true })
    print("Accepted")

    -- Monitor status and re‑accept if needed
    local success = monitorAndReAccept(main, tradeRemote, 5)

    if success then
        print("Both accepted, waiting for countdown/notes...")
        randomDelay(10, 12)
    end

    if tradeCompleted then
        print("Trade completed successfully.")
    elseif tradeCanceled then
        print("Trade was canceled.")
    else
        print("Trade ended without note (may be incomplete).")
    end

    return true
end

-- ============================================
-- RECEIVER FUNCTIONS
-- ============================================
local function acceptPendingTrade()
    local tradeMenu = playerGui:FindFirstChild("TradeMenu")
    if not tradeMenu then return false end
    local main = tradeMenu:FindFirstChild("Main")
    if not main then return false end
    local menu = main:FindFirstChild("Menu")
    if not menu then return false end
    local pending = menu:FindFirstChild("PendingTrades")
    if not pending then return false end
    local list = pending:FindFirstChild("List")
    if not list then return false end

    for _, child in ipairs(list:GetChildren()) do
        if child.Name == SENDER_NAME then
            print("Trade found. Accepting (non‑blocking)...")

            coroutine.wrap(function()
                pcall(function()
                    ReplicatedStorage.Events.trade:InvokeServer({
                        tradeFeedback = true,
                        tradePlayer = Players[SENDER_NAME],
                        accept = true
                    })
                end)
            end)()

            handleConfirmation()
            return true
        end
    end
    return false
end

local function receiverCompleteTrade()
    print("Waiting for TradeGUI (up to 20s)...")
    local tradeGUI = nil
    local start = tick()
    while tick() - start < 20 do
        tradeGUI = playerGui:FindFirstChild("TradeGUI")
        if tradeGUI then
            print("TradeGUI found.")
            break
        end
        task.wait(1)
    end
    if not tradeGUI then
        print("TradeGUI not found – trade may have failed.")
        return false
    end
    local main = tradeGUI:FindFirstChild("Main")
    if not main then return false end

    local tradeRemote = ReplicatedStorage:FindFirstChild("trade")
    if not tradeRemote or not tradeRemote:IsA("RemoteEvent") then
        tradeRemote = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("trade")
    end
    if not tradeRemote then
        warn("Trade remote not found")
        return false
    end

    -- Add junk item if not already present
    if not hasAddedItem(ITEM_NAME) then
        tradeRemote:FireServer({ addItem = ITEM_NAME, customCount = 1 })
        print("Added junk item, waiting for confirmation...")
        local waitStart = tick()
        while tick() - waitStart < 5 do
            if hasAddedItem(ITEM_NAME) then
                print("Junk item confirmed.")
                break
            end
            task.wait(0.5)
        end
        if not hasAddedItem(ITEM_NAME) then
            print("Junk item did not appear, retrying...")
            tradeRemote:FireServer({ addItem = ITEM_NAME, customCount = 1 })
            task.wait(2)
            if not hasAddedItem(ITEM_NAME) then
                print("Failed to add junk item, aborting trade.")
                return false
            end
        end
    else
        print("Junk item already added")
    end

    -- Wait for sender to add their item
    if not waitForBothItemsAdded(20) then
        print("Sender did not add item in time, aborting.")
        return false
    end

    randomDelay(2, 3)
    tradeRemote:FireServer({ accept = true })
    print("Accepted")

    local success = monitorAndReAccept(main, tradeRemote, 5)

    if success then
        randomDelay(10, 12)
    else
        print("Trade did not reach accepted state within timeout.")
        return false
    end

    -- Wait for trade to close
    local closed = false
    start = tick()
    while tick() - start < 15 do
        if not playerGui:FindFirstChild("TradeGUI") then
            closed = true
            break
        end
        task.wait(1)
    end
    return closed
end

-- ============================================
-- IMPEL DOWN FARMING SCRIPT (PLACEHOLDER)
-- ============================================
local function farmImpelDown()
    print("=== STARTING IMPEL DOWN FARM ===")
    task.wait(60)
    print("=== FINISHED FARMING ===")
end

-- ============================================
-- MAIN EXECUTION
-- ============================================
if player.Name == SENDER_NAME then
    print("=== SENDER MODE ===")

    if game.PlaceId == TRADE_HUB_ID then
        print("In trade hub. Attempting trade...")
        sendTrade()
        local success = executeTrade()
        if success then
            print("Trade completed.")
        else
            print("Trade failed.")
        end
        leaveTradeHub()

    elseif game.PlaceId == MAIN_MENU_ID then
        local itemCount = getItemCount(ITEM_NAME)
        print("Current " .. ITEM_NAME .. " count: " .. itemCount)

        if itemCount > 0 then
            print("Items found. Joining trade hub...")
            joinPrivateServer()
        else
            print("No items found. Starting Impel Down farm...")
            farmImpelDown()
        end

    else
        warn("Unknown place ID: " .. game.PlaceId)
    end

elseif player.Name == RECEIVER_NAME then
    print("=== RECEIVER MODE ===")

    if game.PlaceId == TRADE_HUB_ID then
        print("Receiver ready in trade hub. Waiting for trades...")
        local cooldown = 0
        while true do
            if cooldown > 0 then
                task.wait(cooldown)
                cooldown = 0
            end
            if acceptPendingTrade() then
                local success = receiverCompleteTrade()
                if success then
                    print("Trade completed. Cooldown before next trade.")
                else
                    print("Trade failed. Cooldown before next trade.")
                end
                tradeCompleted = false
                tradeCanceled = false
                cooldown = 5
            else
                task.wait(3)
            end
        end

    elseif game.PlaceId == MAIN_MENU_ID then
        print("In main menu. Joining trade hub...")
        joinPrivateServer()

    else
        warn("Unknown place ID: " .. game.PlaceId)
    end

else
    warn("Unknown account: " .. player.Name)
end
