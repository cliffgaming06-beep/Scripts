repeat task.wait(0.1) until game:IsLoaded()
task.wait(5) -- Initial wait for everything to load

if not getgenv().MC_Trading_Config then
    error("MC_Trading_Config not found!")
end

local CONFIG = getgenv().MC_Trading_Config

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local username = player.Name

local DATA_FOLDER = "MC_Trading_System/"

-- ==================== UTILITIES ====================
local function log(msg)
    if CONFIG.Debug then print("[MC-TRADE] " .. msg) end
end

local function waitForMenu()
    log("Waiting for menu to load...")
    local startTime = tick()
    while tick() - startTime < 10 do
        local pg = player:FindFirstChild("PlayerGui")
        if pg then
            if pg:FindFirstChild("Start") or pg:FindFirstChild("chooseType") then
                task.wait(CONFIG.Timings.MenuLoadDelay or 3)
                return true
            end
        end
        task.wait(0.5)
    end
    return false
end

local function ensureFolder()
    if not isfolder(DATA_FOLDER) then makefolder(DATA_FOLDER) end
end

local function saveData(filename, data)
    ensureFolder()
    pcall(function()
        writefile(DATA_FOLDER .. filename .. ".json", HttpService:JSONEncode(data))
    end)
end

local function loadData(filename)
    local path = DATA_FOLDER .. filename .. ".json"
    if isfile(path) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(path))
        end)
        if success then return data end
    end
    return nil
end

-- ==================== ACCOUNT TYPE ====================
local function isFarmingAlt()
    for _, alt in pairs(CONFIG.FarmingAlts) do
        if alt == username then return true end
    end
    return false
end

local function isReceivingMain()
    for _, main in pairs(CONFIG.ReceivingMains) do
        if main.Name == username then return true end
    end
    return false
end

-- ==================== LOCATION CHECKS ====================
local function isMainMenu()
    local success, result = pcall(function()
        local pg = player:WaitForChild("PlayerGui")
        return pg:FindFirstChild("Start") and pg.Start:FindFirstChild("Menu")
    end)
    return success and result
end

local function isTradeHub()
    local success, result = pcall(function()
        local pg = player:WaitForChild("PlayerGui")
        return pg:FindFirstChild("TradeMenu") or pg:FindFirstChild("chooseType")
    end)
    return success and result
end

local function isTrading()
    local success, result = pcall(function()
        return player:WaitForChild("PlayerGui"):FindFirstChild("TradeGUI") ~= nil
    end)
    return success and result
end

-- ==================== MC COUNT ====================
local function getMCCount()
    local success, result = pcall(function()
        local statsPath = ReplicatedStorage:WaitForChild("Stats" .. username)
            :WaitForChild("Inventory")
            :WaitForChild("Inventory")
        local data = statsPath.Value
        local inventory = HttpService:JSONDecode(data)
        return inventory["Mythical Fruit Chest"] or 0
    end)
    return success and result or 0
end

-- ==================== TELEPORT FUNCTIONS ====================
local function teleportToMainMenu()
    log("Teleporting to Main Menu...")
    TeleportService:Teleport(CONFIG.MainGamePlaceId, player)
end

local function teleportToTradeHub()
    log("Teleporting to Trade Hub...")
    
    -- Wait for menu to be ready
    if not waitForMenu() then
        log("Menu didn't load in time, retrying...")
        task.wait(5)
    end
    
    local success = pcall(function()
        ReplicatedStorage.Events.reserved:InvokeServer(CONFIG.PSCode)
    end)
    
    if not success then
        log("Reserved server failed, trying main menu first...")
        teleportToMainMenu()
    end
end

local function joinTradeHubLobby()
    log("Joining Trade Hub lobby...")
    
    -- Wait for chooseType GUI with retry
    local chooseType = nil
    for i = 1, 20 do
        chooseType = player:WaitForChild("PlayerGui"):FindFirstChild("chooseType")
        if chooseType then break end
        task.wait(0.5)
    end
    
    if not chooseType then
        log("chooseType not found!")
        return false
    end
    
    -- Wait for frame to load
    task.wait(CONFIG.Timings.MenuLoadDelay or 3)
    
    -- Click Trade Hub button
    local success = pcall(function()
        local frame = chooseType:WaitForChild("Frame", 5)
        if frame then
            local remoteEvent = frame:WaitForChild("RemoteEvent", 5)
            if remoteEvent then
                task.wait(CONFIG.Timings.ButtonClickDelay or 1)
                remoteEvent:FireServer("tradeHub")
                log("Fired tradeHub event")
                return true
            end
        end
        return false
    end)
    
    if success then
        task.wait(3) -- Wait for teleport/load
    end
    
    return success
end

-- ==================== IMPEL DOWN ====================
local function executeImpelScript()
    log("Starting Impel Down farming...")
    
    -- Set the key as GLOBAL (not in table) - THIS IS THE FIX
    getgenv().script_key = CONFIG.ImpelScriptKey
    
    -- Set their config
    getgenv().Config = CONFIG.ImpelScriptConfig
    
    -- Small delay before loading
    task.wait(2)
    
    -- Load the script
    local success, err = pcall(function()
        loadstring(game:HttpGet(CONFIG.ImpelScriptURL))()
    end)
    
    if not success then
        log("Failed to load Impel script: " .. tostring(err))
    end
end

-- ==================== TRADE FUNCTIONS ====================
local function findPlayer(name)
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name == name then return p end
    end
    return nil
end

local function sendTradeRequest(targetName)
    log("Sending trade to: " .. targetName)
    
    -- Click confirmation with delay
    pcall(function()
        local confirm = player:WaitForChild("PlayerGui"):FindFirstChild("ConfirmationPrompt")
        if confirm then
            task.wait(1)
            confirm.RemoteEvent:FireServer("I understand")
        end
    end)
    task.wait(2)
    
    pcall(function()
        ReplicatedStorage.trade:FireServer({requestTrade = targetName})
    end)
end

local function addMCToTrade(amount)
    log("Adding " .. amount .. " MC to trade")
    task.wait(1)
    pcall(function()
        ReplicatedStorage.trade:FireServer({
            addItem = "Mythical Fruit Chest",
            customCount = amount
        })
    end)
    task.wait(1)
end

local function confirmTrade()
    log("Confirming trade...")
    task.wait(1)
    pcall(function()
        ReplicatedStorage.trade:FireServer({accept = true})
    end)
end

local function waitForTradeComplete()
    local completed = false
    local connection = ReplicatedStorage.Events.note.OnClientEvent:Connect(function(msg)
        if msg and msg:find("Trade completed") then
            completed = true
        end
    end)
    
    for i = 1, CONFIG.Timings.TradeTimeout do
        if completed then break end
        task.wait(1)
    end
    
    connection:Disconnect()
    return completed
end

-- ==================== MAIN ACCOUNT LOGIC ====================
local function getActiveMain()
    for _, main in pairs(CONFIG.ReceivingMains) do
        if main.Active then return main end
    end
    return CONFIG.ReceivingMains[1]
end

local function updateMainMCs(mainName, count)
    for i, main in pairs(CONFIG.ReceivingMains) do
        if main.Name == mainName then
            CONFIG.ReceivingMains[i].CurrentMCs = count
            saveData("mains_status", CONFIG.ReceivingMains)
            break
        end
    end
end

local function rotateMainIfNeeded()
    local activeMain = getActiveMain()
    local currentMCs = getMCCount()
    updateMainMCs(activeMain.Name, currentMCs)
    
    if currentMCs >= activeMain.MaxMCs then
        log(activeMain.Name .. " is full! Rotating...")
        
        for i, main in pairs(CONFIG.ReceivingMains) do
            if main.Name ~= activeMain.Name then
                local theirData = loadData("main_" .. main.Name)
                local theirMCs = theirData and theirData.CurrentMCs or 0
                
                if theirMCs < main.MaxMCs then
                    for j, _ in pairs(CONFIG.ReceivingMains) do
                        CONFIG.ReceivingMains[j].Active = false
                    end
                    CONFIG.ReceivingMains[i].Active = true
                    saveData("mains_status", CONFIG.ReceivingMains)
                    log("Rotated to: " .. main.Name)
                    return main
                end
            end
        end
        log("All mains full!")
        return nil
    end
    return activeMain
end

local function receivingMainLoop()
    log("=== RECEIVING MAIN MODE ===")
    
    if not isTradeHub() then
        if isMainMenu() then
            teleportToTradeHub()
            task.wait(8) -- Wait for full load
        else
            teleportToMainMenu()
            task.wait(8)
            return
        end
    end
    
    -- Wait for menu and join lobby
    if waitForMenu() then
        joinTradeHubLobby()
    end
    
    saveData("main_" .. username, {
        Name = username,
        CurrentMCs = getMCCount(),
        Status = "waiting"
    })
    
    while true do
        local activeMain = rotateMainIfNeeded()
        if not activeMain then
            log("All full, waiting...")
            task.wait(30)
            continue
        end
        
        if activeMain.Name == username and isTrading() then
            log("Trade detected!")
            pcall(function()
                ReplicatedStorage.trade:FireServer({accept = true})
            end)
            task.wait(3)
            confirmTrade()
            
            if waitForTradeComplete() then
                log("Trade done!")
                updateMainMCs(username, getMCCount())
                task.wait(CONFIG.Timings.PostTradeDelay)
            end
        end
        
        task.wait(1)
    end
end

-- ==================== FARMING ALT LOGIC ====================
local function farmingAltLoop()
    log("=== FARMING ALT MODE ===")
    
    while true do
        if isMainMenu() then
            local mcCount = getMCCount()
            log("MCs: " .. mcCount)
            
            saveData("alt_" .. username, {
                Name = username,
                MCs = mcCount,
                Status = mcCount > 0 and "trading" or "farming"
            })
            
            if mcCount > 0 then
                log("Going to trade " .. mcCount .. " MCs")
                teleportToTradeHub()
                task.wait(8) -- Wait for teleport
                
            else
                log("No MCs, farming...")
                -- Wait for menu to be fully loaded
                waitForMenu()
                executeImpelScript()
                while true do task.wait(60) end
            end
            
        elseif isTradeHub() then
            local status = loadData("alt_" .. username)
            local mcCount = status and status.MCs or getMCCount()
            
            if mcCount > 0 then
                -- Wait for menu then join lobby
                if waitForMenu() then
                    joinTradeHubLobby()
                end
                
                local activeMain = getActiveMain()
                local mainFound = false
                
                for i = 1, 60 do
                    if findPlayer(activeMain.Name) then
                        mainFound = true
                        break
                    end
                    task.wait(1)
                end
                
                if mainFound then
                    sendTradeRequest(activeMain.Name)
                    task.wait(3)
                    addMCToTrade(mcCount)
                    task.wait(2)
                    confirmTrade()
                    
                    if waitForTradeComplete() then
                        log("Trade success!")
                        saveData("alt_" .. username, {MCs = 0, Status = "farming"})
                        task.wait(3)
                        teleportToMainMenu()
                        task.wait(8)
                    end
                else
                    log("Main not found, retrying...")
                end
            else
                log("No MCs in Trade Hub, returning to farm")
                teleportToMainMenu()
                task.wait(8)
            end
            
        else
            log("In game, checking...")
            local status = loadData("alt_" .. username)
            
            if not status or status.Status ~= "farming" then
                saveData("alt_" .. username, {MCs = 0, Status = "farming"})
            end
            
            waitForMenu()
            executeImpelScript()
            while true do task.wait(60) end
        end
        
        task.wait(CONFIG.Timings.CheckInterval)
    end
end

-- ==================== INIT ====================
local function init()
    log("MC TRADING SYSTEM v2.2")
    log("Account: " .. username)
    
    ensureFolder()
    
    -- Wait for initial menu load
    waitForMenu()
    
    if isFarmingAlt() then
        farmingAltLoop()
    elseif isReceivingMain() then
        receivingMainLoop()
    else
        warn("Account not in config: " .. username)
    end
end

init()
